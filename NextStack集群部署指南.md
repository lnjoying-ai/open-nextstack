# 🔧 NextStack集群部署指南

> 本文档适用于 ElasticCloud 平台在 NextStack 架构下的多节点集群部署。请由运维工程师在部署前确认环境，并严格按照本标准逐项检查执行，确保集群稳定性、安全性和可扩展性。

---

## 1️⃣ 环境准备

### 1.1 管理节点系统要求

| 项目     | 要求                                                         |
| -------- | ------------------------------------------------------------ |
| 操作系统 | Ubuntu 22.04 LTS                                             |
| CPU      | 每节点 ≥32核（建议使用Intel Xeon Gold/Platinum 或 AMD EPYC系列） |
| 内存     | 每节点 ≥16GB（推荐32GB以上以支持高并发控制面服务）           |
| 磁盘     | 系统盘：≥512GB NVMe SSD；数据盘：≥2TB，建议RAID1或RAID5配置  |
| 网络     | 支持双网卡绑定（bonding），保障管理网络与业务网络隔离        |
| 时间同步 | 必须配置NTP服务，与统一时间源（如内网NTP服务器或阿里云NTP）保持同步 |
|          |                                                              |

---

### 1.2 计算节点（GPU/CPU）系统要求

| 项目     | 要求                                                         |
| -------- | ------------------------------------------------------------ |
| 操作系统 | Ubuntu 22.04 LTS                                             |
| CPU      | 每节点 ≥64核（建议使用Intel Xeon Gold/Platinum 或 AMD EPYC系列） |
| 内存     | 每节点 ≥64GB（GPU节点建议 ≥128GB）                           |
| 磁盘     | 系统盘：≥512GB NVMe SSD；数据盘：≥8TB，建议使用单独共享存储池 |
| GPU      | 支持NVIDIA 4090/A100等主流GPU卡                              |
| 网络     | 双端口10Gbps以上网卡                                         |

---

## 2️⃣ 网络规划

### 2.1 网络平面划分【标准最佳形态】

| 网络类型 | 子网示例        | VLAN ID示例 | 带宽要求             | 用途说明                                        |
| -------- | --------------- | ----------- | -------------------- | ----------------------------------------------- |
| 管理网络 | 192.168.10.0/24 | 10          | >=1Gbps              | 节点间心跳、SSH、监控采集                       |
| 业务网络 | 10.100.0.0/16   | 100         | >=10Gbps（推荐25G+） | 负责集群计算节点间的东西向流量                  |
| 外部网络 | 172.16.0.0/16   | 200         | >=10Gbps（推荐25G+） | 负责集群计算节点间的南北向流量                  |
| 存储网络 | 10.200.0.0/16   | 300         | >=25Gbps             | 分布式存储（如Ceph、MinIO）节点间数据共享、复制 |
| 带外管理 | 192.168.99.0/24 | 99          | >=1Gbps              | iDRAC/iLO/IPMI远程带外管理                      |

> ⚠️ **关键原则**：
- 所有网络平面必须物理或逻辑隔离（VLAN/VXLAN）
- 业务网络与存储网络不得共用同一物理链路

---

### 2.2 网络拓扑图
assets/Nextstack架构.jpg


---

### 2.3 集群设备配置实践

#### ✅ 最佳实践配置（Production）

| 设备       | 数量 | 规格说明                                                  |
| ---------- | ---- | --------------------------------------------------------- |
| GPU服务器  | ≥3台 | 详见1.1 管理节点系统要求                                  |
| 管理服务器 | 2台  | 详见1.2计算节点系统要求                                   |
| 存储服务器 | 3台  | Ceph集群或其他共享存储存储，每台≥100TB裸容量，SSD缓存加速 |
| 接入交换机 | 2台  | H3C S6800 54QT，堆叠或M-LAG双活，避免单点故障             |
| 防火墙     | 1台  | H3C F1050，支持ACl、IPS/IDS                               |

#### 🟡 最小可行配置（POC/Test）

| 设备       | 数量 | 说明                     |
| ---------- | ---- | ------------------------ |
| GPU服务器  | 3台  | 详见1.1 管理节点系统要求 |
| 管理服务器 | 1台  | 详见1.2计算节点系统要求  |
| 接入交换机 | 1台  | 支持VLAN划分与Trunk模式  |
| 防火墙     | 1台  | 基础ACL策略控制          |
| 存储       | 可选 | 使用本地盘或NFS临时替代  |

> ⚠️ 注意：最小配置不适用于生产环境，仅用于功能验证。

---

### 2.4 交换机配置与 Trunk 规划（具体命令示例）

#### H3C S6800 配置片段（CLI 示例）

```bash
# 创建VLAN
vlan 10
 name MGMT_NET
vlan 100
 name SERVICE_NET
vlan 200
 name EXTERNAL_NET
vlan 300
 name STORAGE_NET

# 配置上行端口（To Core Switch）为Trunk
interface Ten-GigabitEthernet1/0/48
 port link-type trunk
 port trunk permit vlan 10 100 200 300
```

```bash
# 接入服务器端口（Access or Hybrid）
interface Ten-GigabitEthernet1/0/1
 description To-GPU-Node-01-Port1
 port access vlan 100  # 业务网
#
interface Ten-GigabitEthernet1/0/2
 description To-GPU-Node-01-Port2
 port access vlan 300  # 存储网
```

---

## 3️⃣ 防火墙规划与配置（细化）

### 3.1 集群流量定义

| 流向       | 描述                                                         |
| ---------- | ------------------------------------------------------------ |
| 南北向流量 | Nextstack集群内计算节点之间南北向出口网络，用于和接入交换机对接，负责处理外部网络的请求 |
| 东西向流量 | Nextstack集群内计算节点之间东西向业务网络，用于和业务交换机对接，负责内部vpc网络的互联 |

### 3.2 必须开放的端口清单

| 协议 | 端口范围  | 用途                          |
| ---- | --------- | ----------------------------- |
| TCP  | 22        | SSH远程管理（限制源IP）       |
| TCP  | 443/80    | HTTPS控制台、API入口          |
| TCP  | 2379-2380 | etcd 客户端/peer通信          |
| TCP  | 9100/3000 | Prometheus、Grafana等监控组件 |
| TCP  | 8899      | NextStack平台API端口          |
|      |           |                               |
|      |           |                               |

> ✅ **安全建议**：
- 使用白名单策略限制访问源IP（如运维跳板机IP段）
- 禁用Telnet、FTP等明文协议
- 开启日志审计与异常行为告警

---

## 4️⃣ EIP 池规划

### 4.1 NAT策略配置建议

| 类型        | 配置方式                                              |
| ----------- | ----------------------------------------------------- |
| SNAT        | 所有内部节点访问外网时，统一使用EIP出口（避免IP暴露） |
| DNAT        | 将EIP:443 → 内部Ingress Controller:443                |
| Floating IP | 可用于高可用主备切换（如Keepalived虚拟IP漂移）        |

---

## 5️⃣ 安全与合规补充

### 5.1 基础安全措施

- [ ] 所有节点关闭root远程登录（`PermitRootLogin no`）
- [ ] 使用SSH密钥认证，禁用密码登录
- [ ] 配置fail2ban防止暴力破解
- [ ] 定期更新系统补丁（`unattended-upgrades`启用）
- [ ] 安装主机安全代理（如Wazuh、Aliyun SAS）

### 5.2 网络安全策略

- [ ] 启用交换机端口安全（Port Security）
- [ ] 防止MAC泛洪、ARP欺骗
- [ ] 启用BPDU Guard、Loop Guard
- [ ] 记录所有网络变更（CMDB登记）

---

## 6️⃣ 部署前检查清单（Checklist）

| 检查项                                   | 是否完成 | 备注                    |
| ---------------------------------------- | -------- | ----------------------- |
| 所有服务器安装Ubuntu 22.04并完成基础配置 | ☐        | 包括hostname、时区、DNS |
| 网络平面已按规划完成VLAN划分             | ☐        | 管理/业务/存储分离      |
| 交换机Trunk配置完成并测试连通性          | ☐        | ping测试跨VLAN可达性    |

---

## 7️⃣ 接入分布式云平台纳管（补充）

> 请联系平台管理员添加该集群节点至分布式云控制面。

### 所需信息清单：

| 字段           | 示例值                            | 来源/生成方式                          |
| -------------- | --------------------------------- | -------------------------------------- |
| 节点唯一ID     | `node-01-gpu-a100`                | 由平台注册系统自动生成或手动录入       |
| 节点访问KEY    | `sk_live_xxxxxxxx`                | 平台颁发的API Token，具备读写权限      |
| 节点公网IP     | `203.0.113.10`                    | 若无公网IP，则填写内网IP + NAT映射关系 |
| 内网IP地址     | `10.100.1.10`                     | 用于集群内部通信                       |
| 节点角色       | `gpu-worker`, `master`, `storage` | 标识节点类型                           |
| 标签（Labels） | `gpu=a100`, `zone=shanghai`       | 用于调度策略                           |

> ✅ **接入方式**：
- 通过平台Agent注册

---

## 8️⃣ 附录：常见问题排查指引

| 问题现象         | 可能原因               | 解决方法                              |
| ---------------- | ---------------------- | ------------------------------------- |
| 节点无法加入集群 | 网络不通、防火墙拦截   | 检查VLAN、ping测试、telnet端口        |
| GPU不可见        | 驱动未安装、内核不兼容 | `dkms status`, 重装NVIDIA驱动         |
| 存储性能低下     | 网络延迟高、未启用RDMA | 检查网卡、RDMA状态                    |
| API无法访问      | EIP未绑定、DNAT错误    | 检查防火墙NAT表项                     |
| 时间不同步       | NTP服务异常            | `systemctl restart systemd-timesyncd` |

---

📝 **版本记录**  
- v1.0 初始版本（2025年8月）  
- v1.1 补充安全、网络、部署检查项（2025年8月15日）
