user root;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 1024;
        # multi_accept on;
}

http {

        ##
        # Basic Settings
        ##

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
         server_tokens off;

        # server_names_hash_bucket_size 64;
        # server_name_in_redirect off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ##
        # SSL Settings
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        ##
        # Gzip Settings
        ##

        gzip on;

        # gzip_vary on;
        # gzip_proxied any;
        # gzip_comp_level 6;
        # gzip_buffers 16 8k;
        # gzip_http_version 1.1;
        # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        ##
        # Virtual Host Configs
        ##

        #include /etc/nginx/conf.d/*.conf;
        include /etc/nginx/sites-enabled/*;
    	map $http_upgrade $connection_upgrade {
    		default upgrade;
    		'' close;
	}
	server {
	    listen 80;
	    rewrite ^(.*)$ https://$host/$1 permanent;
	}


        server {
            #listen 9080  ssl;
            listen 443  ssl;
            listen 80;
            #server_name 120.131.10.40;
	    ssl_certificate /root/web/lnjoying.com.crt;
	    ssl_certificate_key /root/web/lnjoying.com.key;
	    ssl_session_timeout 5m;

            location / {
#                root /root/web/dist;
		proxy_pass https://127.0.0.1:9085$request_uri;
                access_log on;
                autoindex  on;
            }

            location ~ /api/ums {
                proxy_set_header Host 127.0.0.1:8067;
                proxy_pass http://127.0.0.1:8067$request_uri;
                proxy_connect_timeout 600;
                proxy_read_timeout 600;
            }

            location ~ /api/vm {
                proxy_set_header Host 127.0.0.1:8055;
                proxy_pass http://127.0.0.1:8055$request_uri;
                proxy_connect_timeout 600;
                proxy_read_timeout 600;
            }

            location ~ /api/bm {
                proxy_set_header Host 127.0.0.1:8055;
                proxy_pass http://127.0.0.1:8055$request_uri;
                proxy_connect_timeout 600;
                proxy_read_timeout 600;
            }

            location ~ /api/network {
                proxy_set_header Host 127.0.0.1:8055;
                proxy_pass http://127.0.0.1:8055$request_uri;
                proxy_connect_timeout 600;
                proxy_read_timeout 600;
            }

            location ~ /api/repo {       # 可有多个 location 用于配置路由地址
                proxy_set_header Host 127.0.0.1:8055;
                proxy_pass http://127.0.0.1:8055$request_uri;
                proxy_connect_timeout 600;
                proxy_read_timeout 600;
            }

#            location ~ /api/stat {       # 可有多个 location 用于配置路由地址
#                proxy_set_header Host 127.0.0.1:8055;
#                proxy_pass http://127.0.0.1:8055$request_uri;
#                proxy_connect_timeout 600;
#                proxy_read_timeout 600;
#            }
#
#            location ~ /api/bill {       # 可有多个 location 用于配置路由地址
#                proxy_set_header Host 127.0.0.1:8055;
#                proxy_pass http://127.0.0.1:8055$request_uri;
#                proxy_connect_timeout 600;
#                proxy_read_timeout 600;
#            }

            location ~ /api/vnc {
                proxy_set_header Host 127.0.0.1:8055;
                proxy_pass https://127.0.0.1:9085$request_uri;
               # proxy_pass https://dev.lnjoying.io:9085$request_uri;
                proxy_connect_timeout 600;
                proxy_read_timeout 600;

	#	proxy_http_version 1.1;
        #	proxy_set_header Upgrade $http_upgrade;
        #	proxy_set_header Connection $connection_upgrade;

            }
           
            
            location ~ /api/monitor/vm/api/live/ {
#    rewrite  ^/grafana/(.*)  /$1 break;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_set_header Host $http_host;
                proxy_pass http://192.168.11.233:3000;
             }

            location ~ /api/monitor {
               # proxy_set_header Host 127.0.0.1:8055;
                proxy_set_header Host $http_host;
                proxy_pass https://127.0.0.1:9085$request_uri;
                proxy_connect_timeout 600;
                proxy_read_timeout 600;
            }


            location ~ /api {       # 可有多个 location 用于配置路由地址
                proxy_set_header Host 127.0.0.1:8055;
                proxy_pass http://127.0.0.1:8055$request_uri;
                proxy_connect_timeout 600;
                proxy_read_timeout 600;
            }
            

            error_page 401 = /index.html;

        }
}
